<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<!-- saved from url=(0041)http://jyang/update_arcgis_item_test.html -->
<html class="dj_webkit dj_chrome dj_contentbox"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta http-equiv="X-UA-Compatible" content="IE=7,IE=9">
    <!--The viewport meta tag is used to improve the presentation and behavior of the samples 
      on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Update ArcGIS Online Item JSON</title>
    <link rel="stylesheet" type="text/css" href="./UpdateWebMap/claro.css">
    <link rel="stylesheet" href="https://codemirror.net/lib/codemirror.css">
    
    <script type="text/javascript" charset="utf-8" src="./updateWebMap/jsapi_en-us.js"></script><script type="text/javascript" charset="utf-8" src="./UpdateWebMap/svg.js"></script><script type="text/javascript" charset="utf-8" src="./updateWebMap/Portal.js"></script><script type="text/javascript" charset="utf-8" src="./updateWebMap/DeferredList.js"></script><script src="./updateWebMap/codemirror.js"></script>
    <script src="./updateWebMap/javascript.js"></script>
    <script type="text/javascript" src="./updateWebMap/jsl.parser.js"></script>
    <script type="text/javascript" src="//js.arcgis.com/3.9/"></script>
    <script type="text/javascript">var djConfig = {parseOnLoad: true};</script>
    <style type="text/css">
    input {
      width: 300px;
    }
    textarea {
      width: 800px;
      height: 400px;
    }
    .CodeMirror {
      outline: #888 solid 1px;
    };
    </style>
    <script type="text/javascript">
      dojo.require("esri.arcgis.Portal");
      function init() {
        //esri.config.defaults.io.corsEnabledServers.push("http://jsapibuild:8080/online_service/utility/validateJson"); //enable CORS with JSON validate service
        var itemInfo = {}; //an object used to store item information across functions
        dojo.connect(dojo.byId("load"), "onclick", function(){
          itemInfo.portalUrl = 'https://www.arcgis.com';
          itemInfo.itemId = dojo.byId("itemId").value;
          portalSignIn(itemInfo.portalUrl) //sign in to portal
            .then(dojo.partial(findItem, itemInfo)) //find item by id
            .then(dojo.partial(getData, itemInfo)) //get item data
            .then(dojo.partial(intoTextarea, itemInfo), showError); //insert item data into textarea, handle the error if returned
        });
        dojo.connect(dojo.byId("submit"), "onclick", function(){
          itemInfo.codeMirror.save();
          var submitData = itemInfo.codeMirror.getTextArea().value.replace(/\t/g,'  ');
          dojo.byId("submit").disabled = true;
          //jsonValidate(submitData) //validate JSON string
          //  .then(dojo.partial(updateData, submitData, itemInfo)); //update item data
          //using new validator
          try {
            var result = jsl.parser.parse(submitData);
            dojo.byId("status").innerHTML = 'Valid JSON.';
            dojo.byId("submit").disabled = false;
            
            esri.request({
              url: itemInfo.portalUrl + '/sharing/rest/content/users/' + itemInfo.userId + itemInfo.folderPath + '/items/' + itemInfo.itemId + '/update',
              content: {
                text: dojo.toJson(dojo.fromJson(submitData)),
                f: 'json',
                token: itemInfo.userToken
              }
            }, {
              usePost: true
            }).then(showResults);
          } catch (parseException) {
            console.log(parseException.message);
            dojo.byId("status").innerHTML = '<pre>' + parseException.message + '</pre>';
            dojo.byId("submit").disabled = false;
          };
        });
      };
      
      function portalSignIn(url) {
        var portal = new esri.arcgis.Portal(url);
        return portal.signIn();
      };
      
      function findItem(itemInfo, portalUser){
        itemInfo.userId = portalUser.username;
        itemInfo.userToken = portalUser.credential.token;
        var findItemRequest = esri.request({
          url: portalUser.portal.portalUrl + '/content/items/' + itemInfo.itemId + '?f=json&token=' + itemInfo.userToken
        });
        return findItemRequest.then();
      };
      
      function getData(itemInfo, portalItem) {
        dojo.byId("itemTitle").innerHTML = portalItem.title;
        itemInfo.folderPath = portalItem.ownerFolder === null ? '' : '/' + portalItem.ownerFolder;
        var getDataRequest = esri.request({
          url: itemInfo.portalUrl + '/sharing/rest/content/items/' + itemInfo.itemId + '/data?f=json&token=' + itemInfo.userToken
        });
        return getDataRequest.then();
      };
      
      function intoTextarea(itemInfo, itemData){
        if (itemInfo.codeMirror) { itemInfo.codeMirror.toTextArea() }; //kill codeMirror if already exist
        dojo.byId("textarea").value = dojo.toJson(itemData, true).replace(/\t/g,'  ');
        dojo.byId("submit").disabled = false;
        dojo.byId("status").innerHTML = 'Item ' + itemInfo.itemId + ' loaded.';
        //the code below turns the existing textarea into a prettified editable div (codeMirror)
        //code Mirror is stored in itemInfo for later uses
        itemInfo.codeMirror = CodeMirror.fromTextArea(dojo.byId("textarea"),{
          lineNumbers: true,
          tabSize: 2,
          matchBrackets: true,
          extraKeys: {"Enter": "newlineAndIndentContinueComment"}
        });
        itemInfo.codeMirror.setSize(800, 400);
      };
      
      function showError(error){
        dojo.byId("status").innerHTML = 'Error: ' + error.message;
        dojo.byId("submit").disabled = true;
      };
      
      function jsonValidate(jsonString){
        return esri.request({
          url: 'http://jsapibuild:8080/online_service/utility/validateJson',
          content: { json: jsonString }
        }).then();
      };
      
      function updateData(submitData, itemInfo, jsonValid){
        if (jsonValid.isValid) {
          dojo.byId("status").innerHTML = 'Valid JSON.';
          esri.request({
            url: itemInfo.portalUrl + '/sharing/rest/content/users/' + itemInfo.userId + itemInfo.folderPath + '/items/' + itemInfo.itemId + '/update',
            content: {
              text: dojo.toJson(dojo.fromJson(submitData)),
              f: 'json',
              token: itemInfo.userToken
            }
          }, {
            usePost: true
          }).then(showResults);
        } else {
          console.log('Failed. ' + jsonValid.message);
          dojo.byId("status").innerHTML = jsonValid.message;
          dojo.byId("submit").disabled = false;
        };
      };
      
      function showResults(results){
        console.log(results);
        dojo.byId("status").innerHTML += ' Update success.';
        setTimeout(function(){
          dojo.byId("submit").disabled = false;
          dojo.byId("status").innerHTML = '';
        },2000);
      };

      dojo.addOnLoad(init);
    </script>
  <link type="text/css" rel="stylesheet" href="chrome-extension://cpngackimfmofbokmjmljamhdncknpmg/style.css"><script type="text/javascript" charset="utf-8" src="chrome-extension://cpngackimfmofbokmjmljamhdncknpmg/js/page_context.js"></script></head>
  <body class="claro" style="font-family:Arial Unicode MS,Arial,sans-serif;" screen_capture_injected="true">
    <p>
      <div><b>Item ID:</b> <input id="itemId" type="text"></div>
      <div><button id="load">Load Item</button></div>
    <p></p>
    <p>
      </p><div><b>Title:</b> <span id="itemTitle"></span></div>
      <textarea id="textarea"></textarea>
      <div><button id="submit" disabled="">Validate &amp; Submit</button></div>
    <p></p>
    <p><b>Status:</b> <span id="status"></span></p>
  
</body></html>
